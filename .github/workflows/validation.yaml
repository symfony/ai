name: Validate

on:
    push:
        paths:
            - 'src/*/src/Bridge/**/*'
            - 'src/*/composer.json'
            - 'src/ai-bundle/config/options.php'
            - 'splitsh.json'
            - '.github/workflows/validation.yaml'
            - '.github/scripts/validate-bridge-naming.sh'
            - '.github/scripts/validate-bridge-splitsh.sh'
            - '.github/scripts/validate-bridge-files.sh'
            - '.github/scripts/validate-bridge-type.sh'
            - '.github/scripts/validate-bridge-deptrac.sh'
            - '.github/scripts/validate-dependency-versions.sh'
            - 'deptrac.yaml'
    pull_request:
        paths:
            - 'src/*/src/Bridge/**/*'
            - 'src/*/composer.json'
            - 'src/ai-bundle/config/options.php'
            - 'splitsh.json'
            - '.github/workflows/validation.yaml'
            - '.github/scripts/validate-bridge-naming.sh'
            - '.github/scripts/validate-bridge-splitsh.sh'
            - '.github/scripts/validate-bridge-files.sh'
            - '.github/scripts/validate-bridge-type.sh'
            - '.github/scripts/validate-bridge-deptrac.sh'
            - '.github/scripts/validate-dependency-versions.sh'
            - 'deptrac.yaml'

concurrency:
    group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
    cancel-in-progress: true

jobs:
    validate_stores:
        name: Store Bridges
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Fetch base branch for LICENSE validation
              run: git fetch origin ${{ github.base_ref || 'main' }} --depth=1

            - name: Validate store bridge naming conventions
              run: .github/scripts/validate-bridge-naming.sh store store src/ai-bundle/config/options.php

            - name: Validate store bridges are in splitsh.json
              run: .github/scripts/validate-bridge-splitsh.sh store

            - name: Validate store bridges have required files
              run: .github/scripts/validate-bridge-files.sh store

            - name: Validate store bridges have correct type
              run: .github/scripts/validate-bridge-type.sh store

            - name: Validate store bridges are covered in deptrac.yaml
              run: .github/scripts/validate-bridge-deptrac.sh store store

    validate_tools:
        name: Tool Bridges
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Fetch base branch for LICENSE validation
              run: git fetch origin ${{ github.base_ref || 'main' }} --depth=1

            - name: Validate tool bridge naming conventions
              run: .github/scripts/validate-bridge-naming.sh tool agent

            - name: Validate tool bridges are in splitsh.json
              run: .github/scripts/validate-bridge-splitsh.sh tool agent

            - name: Validate tool bridges have required files
              run: .github/scripts/validate-bridge-files.sh tool agent

            - name: Validate tool bridges have correct type
              run: .github/scripts/validate-bridge-type.sh tool agent

            - name: Validate tool bridges are covered in deptrac.yaml
              run: .github/scripts/validate-bridge-deptrac.sh tool agent

    validate_message_stores:
        name: Message Store Bridges
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Fetch base branch for LICENSE validation
              run: git fetch origin ${{ github.base_ref || 'main' }} --depth=1

            - name: Validate message store bridge naming conventions
              run: .github/scripts/validate-bridge-naming.sh message-store chat

            - name: Validate message store bridges are in splitsh.json
              run: .github/scripts/validate-bridge-splitsh.sh message-store chat

            - name: Validate message store bridges have required files
              run: .github/scripts/validate-bridge-files.sh message-store chat

            - name: Validate message store bridges have correct type
              run: .github/scripts/validate-bridge-type.sh message-store chat

            - name: Validate message store bridges are covered in deptrac.yaml
              run: .github/scripts/validate-bridge-deptrac.sh message-store chat

    validate_platforms:
        name: Platform Bridges
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Fetch base branch for LICENSE validation
              run: git fetch origin ${{ github.base_ref || 'main' }} --depth=1

            - name: Validate platform bridge naming conventions
              run: .github/scripts/validate-bridge-naming.sh platform platform

            - name: Validate platform bridges are in splitsh.json
              run: .github/scripts/validate-bridge-splitsh.sh platform

            - name: Validate platform bridges have required files
              run: .github/scripts/validate-bridge-files.sh platform

            - name: Validate platform bridges have correct type
              run: .github/scripts/validate-bridge-type.sh platform

            - name: Validate platform bridges are covered in deptrac.yaml
              run: .github/scripts/validate-bridge-deptrac.sh platform platform

    validate_mate_bridges:
        name: Mate Bridges
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Fetch base branch for LICENSE validation
              run: git fetch origin ${{ github.base_ref || 'main' }} --depth=1

            - name: Validate Mate bridge naming conventions
              run: .github/scripts/validate-bridge-naming.sh mate-extension mate

            - name: Validate Mate bridges are in splitsh.json
              run: .github/scripts/validate-bridge-splitsh.sh mate

            - name: Validate Mate bridges have required files
              run: .github/scripts/validate-bridge-files.sh mate

            - name: Validate Mate bridges have correct type
              run: .github/scripts/validate-bridge-type.sh mate

            - name: Validate Mate bridges are covered in deptrac.yaml
              run: .github/scripts/validate-bridge-deptrac.sh mate-extension mate

    validate_dependency_versions:
        name: "Validate ${{ matrix.package }} requires version ${{ matrix.version }}"
        runs-on: ubuntu-latest
        strategy:
            fail-fast: false
            matrix:
                include:
                    - package: phpunit/phpunit
                      version: "^11.5.53"
                    - package: phpstan/phpstan
                      version: "^2.1"
                    - package: phpstan/phpstan-phpunit
                      version: "^2.0"
                    - package: phpstan/phpstan-strict-rules
                      version: "^2.0"
        steps:
            - name: Checkout
              uses: actions/checkout@v6

            - name: Validate ${{ matrix.package }} version in all composer.json files
              run: .github/scripts/validate-dependency-versions.sh "${{ matrix.package }}" "${{ matrix.version }}"
