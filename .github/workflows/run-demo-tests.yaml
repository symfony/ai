name: Run Demo Panther Tests

on:
    # Using pull_request_target to access repository secrets for fork PRs
    pull_request_target:
        types: [labeled]

defaults:
    run:
        working-directory: demo

jobs:
    panther-tests:
        if: github.event.label.name == 'Run demo tests'
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  # Checkout the PR head to test actual PR code (pull_request_target defaults to base branch)
                  ref: ${{ github.event.pull_request.head.sha }}

            - name: Setup PHP
              uses: shivammathur/setup-php@v2
              with:
                  php-version: '8.4'
                  tools: flex
                  extensions: gd, mongodb, redis

            - name: Install root dependencies
              uses: ramsey/composer-install@v3
              with:
                  working-directory: "."

            - name: Build packages
              working-directory: .
              run: php .github/build-packages.php

            - name: Install demo dependencies
              uses: ramsey/composer-install@v3
              with:
                  working-directory: "demo"

            - name: Link local packages
              run: ../link

            - name: Run auto-scripts
              run: composer run-script auto-scripts --no-interaction

            - name: Setup ChromaDB
              run: docker compose up -d
              working-directory: .

            - name: Wait for ChromaDB to be ready
              run: |
                  timeout 60 bash -c 'until curl -f http://localhost:8000/api/v1/heartbeat 2>/dev/null; do sleep 2; done'
              working-directory: .

            - name: Initialize ChromaDB with blog data
              run: bin/console ai:store:index blog -vv
              env:
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}

            - name: Install Chrome Driver
              run: vendor/bin/bdi driver:chromedriver --install
              working-directory: demo

            - name: Start Symfony server
              run: symfony server:start -d --port=9080 --no-tls
              working-directory: demo

            - name: Wait for server to be ready
              run: |
                  timeout 60 bash -c 'until curl -f http://127.0.0.1:9080 2>/dev/null; do sleep 2; done'

            - name: Run Panther tests
              run: vendor/bin/phpunit --testsuite=panther
              env:
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
                  HUGGINGFACE_API_TOKEN: ${{ secrets.HUGGINGFACE_API_TOKEN }}
                  PANTHER_EXTERNAL_BASE_URI: http://127.0.0.1:9080
                  PANTHER_APP_ENV: dev

            - name: Upload screenshots on failure
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                  name: panther-error-screenshots
                  path: demo/var/error-screenshots/
                  if-no-files-found: ignore

            - name: Stop Symfony server
              if: always()
              run: symfony server:stop
              working-directory: demo

            - name: Stop ChromaDB
              if: always()
              run: docker compose down
              working-directory: .
